<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Fitting. Measurements · HetaSimulator Docs</title><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-149749027-1', 'auto');
ga('send', 'pageview', {'page': location.pathname + location.search + location.hash});
</script><link rel="canonical" href="https://hetalang.github.io/HetaSimulator.jl/dev/tutorial/fit/"/><link href="https://fonts.googleapis.com/css?family=Lato|Roboto+Mono" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.0/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.0/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.0/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit">HetaSimulator Docs</span></div><form class="docs-search" action="../../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><span class="tocitem">Basics</span><ul><li><a class="tocitem" href="../../basics/overview/">Quick start</a></li><li><a class="tocitem" href="../../basics/distributed/">Parallel simulations</a></li><li><a class="tocitem" href="../../table-formats/scenario/">Scenarios tables</a></li><li><a class="tocitem" href="../../table-formats/measurement/">Measurements tables</a></li><li><a class="tocitem" href="../../table-formats/parameters/">Parameters tables</a></li></ul></li><li><span class="tocitem">Tutorial</span><ul><li><a class="tocitem" href="../intro/">Introduction</a></li><li><a class="tocitem" href="../sim/">Scenario. Simulation</a></li><li><a class="tocitem" href="../mc/">Monte-Carlo. Statistics calculation</a></li><li class="is-active"><a class="tocitem" href>Fitting. Measurements</a><ul class="internal"><li><a class="tocitem" href="#Working-example"><span>Working example</span></a></li><li><a class="tocitem" href="#Load-measurements"><span>Load measurements</span></a></li><li><a class="tocitem" href="#Fitting"><span>Fitting</span></a></li><li><a class="tocitem" href="#Fitting-with-parameters-table"><span>Fitting with parameters table</span></a></li><li><a class="tocitem" href="#Additional-optimization-specific-options"><span>Additional optimization-specific options</span></a></li></ul></li></ul></li><li><a class="tocitem" href="../../api/">API</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Tutorial</a></li><li class="is-active"><a href>Fitting. Measurements</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Fitting. Measurements</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/hetalang/HetaSimulator.jl/blob/master/docs/src/tutorial/fit.md" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Fitting.-Measurements"><a class="docs-heading-anchor" href="#Fitting.-Measurements">Fitting. Measurements</a><a id="Fitting.-Measurements-1"></a><a class="docs-heading-anchor-permalink" href="#Fitting.-Measurements" title="Permalink"></a></h1><p>The <a href="../../api/#HetaSimulator.fit-Tuple{Platform, Any}"><code>fit</code></a> can be used to evaluate a model parameters based on experimental data. Typically the method is applied for the whole platform but can be also used for selected <code>Scenario</code>s.</p><p>_Before start be sure you have the latest <strong>HetaSimulator.jl</strong> version. If you don&#39;t have it reinstall using the Julia environment.</p><pre><code class="language-julia">] # switch to Pkg mode
add HetaSimulator</code></pre><h2 id="Working-example"><a class="docs-heading-anchor" href="#Working-example">Working example</a><a id="Working-example-1"></a><a class="docs-heading-anchor-permalink" href="#Working-example" title="Permalink"></a></h2><p>This lesson uses the following model code.</p><p>File can be downloaded here: <a href="../fit-files/index.heta">index.heta</a></p><pre><code class="language-heta">// Compartments
Vol0 @Compartment .= 1;
Vol1 @Compartment .= 6.3;
Vol2 @Compartment .= 10.6;

// Species
A0 @Species {compartment: Vol0, isAmount: true, output: true} .= 0;
C1 @Species {compartment: Vol1, output: true} .= 0;
C2 @Species {compartment: Vol2, output: true} .= 0;

// Reactions
v_abs @Reaction {actors: A0 = C1} := kabs * A0;
v_el @Reaction {actors: C1 =} := Vol1 * (kel * C1); // Vol1 * (kmax * C1 / (Km + C1));
v_distr @Reaction {actors: C1 = C2} := Q * (C1 - C2);

// Parameters
dose @Const = 20;
kabs @Const = 20;
kel @Const = 0.5;
Q @Const = 1.0;
// kmax @Const = 3e3;
// Km @Const = 9e3;

// single dose event
sw1 @TimeSwitcher {start: 0};
A0 [sw1]= dose;

// multiple dose event, default off
sw2 @TimeSwitcher {start: 0, period: 24, active: false};
A0 [sw2]= dose;

// parameters for fitting
sigma1 @Const = 0.1;
sigma2 @Const = 0.1;
sigma3 @Const = 0.1;</code></pre><p>Download the file or create  <strong>index.heta</strong> with VSCode in the working directory.</p><p>Load the platform into the Julia environment. You should clarify the path to the modeling platform as the first argument. Today we will use the same working directory where the index.heta file is located.</p><pre><code class="language-julia">using HetaSimulator, Plots

p = load_platform(&quot;.&quot;)</code></pre><p>The following table describing 4 scenarios will be used.</p><p><img src="../fit-fig01.png" alt="fig01"/></p><p>File can be downloaded here: <a href="../fit-files/scenarios.csv">scenarios.csv</a></p><p>Load scenarios into the platform.</p><pre><code class="language-julia">scn_df = read_scenarios(&quot;./scenarios.csv&quot;)
add_scenarios!(p, scn_df)</code></pre><h2 id="Load-measurements"><a class="docs-heading-anchor" href="#Load-measurements">Load measurements</a><a id="Load-measurements-1"></a><a class="docs-heading-anchor-permalink" href="#Load-measurements" title="Permalink"></a></h2><p>Experimental data can be used for both: visualizing and parameter estimation. To read more about measurements tables format see the <a href="table-formats/measurement">documentation</a>.</p><p><img src="../fit-fig02.png" alt="fig02"/></p><p>File can be downloaded here: <a href="../fit-files/measurements.csv">measurements.csv</a>. The presented dataset includes the measurement of <code>C1</code> with unknown variance equal for a particular condition.</p><p>The measurement table can be loaded into platform using <code>read_measurements</code> and <code>add_measurements!</code> functions.</p><pre><code class="language-julia">measurements_df = read_measurements(&quot;./measurements.csv&quot;)</code></pre><pre><code class="language-none">90×5 DataFrame
 Row │ t         measurement  prob.mean  prob.sigma  scenario 
     │ Float64   Float64      String     String      Symbol   
─────┼────────────────────────────────────────────────────────
   1 │  0.08333    0.0686283  C1         sigma1      dose_1
   2 │  0.08333    0.0684679  C1         sigma1      dose_1
  ⋮  │    ⋮           ⋮           ⋮          ⋮          ⋮
  89 │ 24.0        1.036      C1         sigma3      dose_100
  90 │ 24.0        0.724612   C1         sigma3      dose_100
                                               86 rows omitted</code></pre><pre><code class="language-julia">add_measurements!(p, measurements_df)

# display platform content
p</code></pre><pre><code class="language-none">Platform with 1 model(s), 4 scenario(s), 90 measurement(s)
   Models: nameless
   Scenarios: dose_1, dose_10, dose_100, multiple_15</code></pre><p>If we run the simulations and then plot them we see the simulation results together with measured values.</p><pre><code class="language-julia"># simulate all
res = sim(p)</code></pre><pre><code class="language-none">4-element Vector{Pair{Symbol, SimResult}}
    :dose_1 =&gt; 80x3 SimResult with status :Success.
    :dose_10 =&gt; 100x3 SimResult with status :Success.
    :dose_100 =&gt; 124x3 SimResult with status :Success.
    :multiple_15 =&gt; 668x3 SimResult with status :Success.</code></pre><pre><code class="language-julia"># plot all default
plot(res)</code></pre><p><img src="../fit-fig03.png" alt="fit-fig03"/></p><p>To display in more convenient way one can use the additional <code>yscale</code> and <code>ylim</code> arguments. </p><pre><code class="language-julia"># plot C1, C2 in log scale
plot(res, vars=[:C1,:C2], yscale=:log10, ylim=(1e-3, 1e3))</code></pre><p><img src="../fit-fig04.png" alt="fit-fig04"/></p><h2 id="Fitting"><a class="docs-heading-anchor" href="#Fitting">Fitting</a><a id="Fitting-1"></a><a class="docs-heading-anchor-permalink" href="#Fitting" title="Permalink"></a></h2><p>Before we run the optimization procedure we should select the parameters to optimize with the starting values.</p><p><code>sigma1</code>, <code>sigma2</code>, <code>sigma3</code> are not included in the main model code. They describe just the variability of error for the scenarios: <code>dose_1</code>, <code>dose_10</code> and <code>dose_100</code>.</p><pre><code class="language-julia"># fitted parameters
to_fit = [
    :kabs =&gt; 8.0,
    :Q =&gt; 4.0,
    :kel =&gt; 2.2,
    :sigma1 =&gt; 0.1,
    :sigma2 =&gt; 0.1,
    :sigma3 =&gt; 0.1,
]
res_optim = fit(p, to_fit) # default fitting</code></pre><pre><code class="language-none">┌ Warning: Scenario &quot;:multiple_15&quot; has no measurements. It will be excluded from fitting.
└ @ HetaSimulator y:\HetaSimulator.jl\src\fit.jl:77
FitResult with status :XTOL_REACHED
   Status: XTOL_REACHED
   Optimal values: [:kabs =&gt; 18.868605026704916, :Q =&gt; 4.043662480774219, :kel =&gt; 0.17104243648378176, :sigma1 =&gt; 0.020347955494158528, :sigma2 =&gt; 0.31561050699802246, :sigma3 =&gt; 0.5716026958426483]
   OF value: 140.96503722971997
   OF count: 8612</code></pre><p>The scenario <code>multiple_15</code> does not include any measurement. That&#39;s why we see the warning message here. This is not an error.</p><p>The optimal value of the parameters can be obtained with <code>optim</code> method applied for <code>FitResult</code>.</p><pre><code class="language-julia"># optimal parameters
optim(res_optim)</code></pre><pre><code class="language-none"> 6-element Vector{Pair{Symbol, Float64}}:
   :kabs =&gt; 18.868605026704916
      :Q =&gt; 4.043662480774219
    :kel =&gt; 0.17104243648378176
 :sigma1 =&gt; 0.020347955494158528
 :sigma2 =&gt; 0.31561050699802246
 :sigma3 =&gt; 0.5716026958426483</code></pre><p>To display the simulations with updated parameters values we can use <code>parameters</code> argument in <code>sim</code>.</p><pre><code class="language-julia"># check fitting quality 
res = sim(p, parameters = optim(res_optim))
plot(res, yscale=:log10, vars=[:C1,:C2], ylims=(1e-3,1e2))</code></pre><p><img src="../fit-fig05.png" alt="fig05"/></p><h2 id="Fitting-with-parameters-table"><a class="docs-heading-anchor" href="#Fitting-with-parameters-table">Fitting with parameters table</a><a id="Fitting-with-parameters-table-1"></a><a class="docs-heading-anchor-permalink" href="#Fitting-with-parameters-table" title="Permalink"></a></h2><p>The parameters set that is used for <code>fit</code> can also be taken from tables. The description of table format can be found in <a href="table-formats/parameters/">documentation</a>.</p><p>For example we will use the following table.</p><p><img src="../fit-fig06.png" alt="fig06"/></p><p>File can be downloaded here: <a href="../fit-files/parameters.csv">parameters.csv</a> The table can be loaded with <code>read_parameters</code> method.</p><pre><code class="language-julia"># read parameters from table
params_df = read_parameters(&quot;./parameters.csv&quot;)</code></pre><pre><code class="language-none">6×6 DataFrame
 Row │ parameter  scale   lower    upper    nominal  estimate 
     │ Symbol     Symbol  Float64  Float64  Float64  Bool     
─────┼────────────────────────────────────────────────────────
   1 │ kabs       lin         1.0    100.0      8.0      true
   2 │ kel        log         0.0     60.0      2.2      true
   3 │ Q          log10       1.0     80.0      4.0      true
   4 │ sigma1     lin         0.0     10.0      0.1      true
   5 │ sigma2     lin         0.0     10.0      0.1      true
   6 │ sigma3     lin         0.0     10.0      0.1      true</code></pre><p>As previously we can use this <code>DataFrame</code> for optimization.</p><pre><code class="language-julia">res_optim = fit(p, params_df)</code></pre><pre><code class="language-none">┌ Warning: Scenario &quot;:multiple_15&quot; has no measurements. It will be excluded from fitting.
└ @ HetaSimulator 
FitResult with status :FTOL_REACHED
   Status: FTOL_REACHED
   Optimal values: [:kabs =&gt; 8.669590504032879, :kel =&gt; 0.2299120380231296, :Q =&gt; 3.386457652767808, :sigma1 =&gt; 0.010105725225267037, :sigma2 =&gt; 0.09951673713071268, :sigma3 =&gt; 0.6024808584834973]
   OF value: -101.7645013649068
   OF count: 417</code></pre><h2 id="Additional-optimization-specific-options"><a class="docs-heading-anchor" href="#Additional-optimization-specific-options">Additional optimization-specific options</a><a id="Additional-optimization-specific-options-1"></a><a class="docs-heading-anchor-permalink" href="#Additional-optimization-specific-options" title="Permalink"></a></h2><p>Internally <code>HetaSimulator</code> uses NLopt library. We can choose the optimization algorithm as well as additional options.</p><p>Read more here: <a href="https://nlopt.readthedocs.io/en/latest/NLopt_Algorithms/">https://nlopt.readthedocs.io/en/latest/NLopt_Algorithms/</a></p><pre><code class="language-julia">res_optim = fit(
    p, 
    params_df, 
    fit_alg = :LN_SBPLX, 
    ftol_abs = 1e-5, 
    ftol_rel = 0, 
    maxeval = 10^6
)
optim(res_optim)</code></pre><p>There are several options which are available for a user.  To know more read about <a href="../../api/#HetaSimulator.fit-Tuple{Platform, Any}"><code>fit</code></a> in API documentation.</p><ul><li><code>fit_alg</code> : fitting algorithm. Default is <code>:LN_NELDERMEAD</code></li><li><code>ftol_abs</code> : absolute tolerance on function value. Default is <code>0.0</code></li><li><code>ftol_rel</code> : relative tolerance on function value. Default is <code>1e-4</code></li><li><code>xtol_rel</code> : relative tolerance on optimization parameters. Default is <code>0.0</code></li><li><code>xtol_rel</code> : absolute tolerance on optimization parameters. Default is <code>0.0</code></li><li><code>maxeval</code> : maximum number of function evaluations. Default is <code>1e4</code></li><li><code>maxtime</code> : maximum optimization time (in seconds). Default is <code>0</code></li></ul></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../mc/">« Monte-Carlo. Statistics calculation</a><a class="docs-footer-nextpage" href="../../api/">API »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> on <span class="colophon-date" title="Tuesday 27 December 2022 20:04">Tuesday 27 December 2022</span>. Using Julia version 1.6.7.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
