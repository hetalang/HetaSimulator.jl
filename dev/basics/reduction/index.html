<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Using reduction_func and output_func · HetaSimulator.jl</title><meta name="title" content="Using reduction_func and output_func · HetaSimulator.jl"/><meta property="og:title" content="Using reduction_func and output_func · HetaSimulator.jl"/><meta property="twitter:title" content="Using reduction_func and output_func · HetaSimulator.jl"/><meta name="description" content="Documentation for HetaSimulator.jl."/><meta property="og:description" content="Documentation for HetaSimulator.jl."/><meta property="twitter:description" content="Documentation for HetaSimulator.jl."/><meta property="og:url" content="https://hetalang.github.io/HetaSimulator.jl/stable/basics/reduction/"/><meta property="twitter:url" content="https://hetalang.github.io/HetaSimulator.jl/stable/basics/reduction/"/><link rel="canonical" href="https://hetalang.github.io/HetaSimulator.jl/stable/basics/reduction/"/><script async src="https://www.googletagmanager.com/gtag/js?id=UA-149749027-1"></script><script>  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'UA-149749027-1', {'page_path': location.pathname + location.search + location.hash});
</script><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../search_index.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../../">HetaSimulator.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><span class="tocitem">Basics</span><ul><li><a class="tocitem" href="../overview/">Quick start</a></li><li><a class="tocitem" href="../distributed/">Parallel simulations</a></li><li><a class="tocitem" href="../../table-formats/scenario/">Scenarios tables</a></li><li><a class="tocitem" href="../../table-formats/measurement/">Measurements tables</a></li><li><a class="tocitem" href="../../table-formats/parameters/">Parameters tables</a></li><li><a class="tocitem" href="../solvers/">Solver choice</a></li><li class="is-active"><a class="tocitem" href>Using <code>reduction_func</code> and <code>output_func</code></a><ul class="internal"><li><a class="tocitem" href="#output_func-examples"><span><code>output_func</code> examples</span></a></li><li><a class="tocitem" href="#reduction_func-examples"><span><code>reduction_func</code> examples</span></a></li></ul></li></ul></li><li><span class="tocitem">Tutorial</span><ul><li><a class="tocitem" href="../../tutorial/intro/">Introduction</a></li><li><a class="tocitem" href="../../tutorial/sim/">Scenario. Simulation</a></li><li><a class="tocitem" href="../../tutorial/mc/">Monte-Carlo. Statistics calculation</a></li><li><a class="tocitem" href="../../tutorial/fit/">Fitting. Measurements</a></li><li><a class="tocitem" href="../../tutorial/gsa/">Global Sensitivity Analysis</a></li><li><a class="tocitem" href="../../tutorial/plots/">Plots</a></li></ul></li><li><a class="tocitem" href="../../api/">API</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Basics</a></li><li class="is-active"><a href>Using <code>reduction_func</code> and <code>output_func</code></a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Using <code>reduction_func</code> and <code>output_func</code></a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/hetalang/HetaSimulator.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/hetalang/HetaSimulator.jl/blob/master/docs/src/basics/reduction.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Using-reduction_func-and-output_func"><a class="docs-heading-anchor" href="#Using-reduction_func-and-output_func">Using <code>reduction_func</code> and <code>output_func</code></a><a id="Using-reduction_func-and-output_func-1"></a><a class="docs-heading-anchor-permalink" href="#Using-reduction_func-and-output_func" title="Permalink"></a></h1><p>When running multiple simulations (Monte Carlo or “virtual patient” simulations) with the <code>mc()</code> or <code>sim</code> functions, you can customize how results are collected using output functions and reduction functions. These optional callbacks let you control what data each simulation returns and how multiple simulation outputs are aggregated:</p><ul><li><p><code>output_func(sol, i)</code> – A function that determines what is saved from each individual simulation’s result. By default, it saves the entire simulation result object. You can override this to save a specific value or summary from each run (it returns a tuple (output, rerun_flag)).</p></li><li><p><code>reduction_func(u, batch, I)</code> – A function that determines how to combine or filter the outputs from batches of simulations. By default, it simply appends each simulation’s output to an array. You can override this to aggregate results (e.g. filtering or computing statistics) as simulations complete (it returns (updated<em>accumulator, stop</em>flag)).</p></li></ul><h2 id="output_func-examples"><a class="docs-heading-anchor" href="#output_func-examples"><code>output_func</code> examples</a><a id="output_func-examples-1"></a><a class="docs-heading-anchor-permalink" href="#output_func-examples" title="Permalink"></a></h2><h3 id="Saving-individual-simulation&#39;s-results"><a class="docs-heading-anchor" href="#Saving-individual-simulation&#39;s-results">Saving individual simulation&#39;s results</a><a id="Saving-individual-simulation&#39;s-results-1"></a><a class="docs-heading-anchor-permalink" href="#Saving-individual-simulation&#39;s-results" title="Permalink"></a></h3><p>This <code>output_func</code> saves each simulation result <code>sol</code> as a CSV file named by its index <code>i</code>. The simulation result is converted to a <code>DataFrame</code> and written to <code>&quot;sol_i.csv&quot;</code>. Since we write to disk we don&#39;t need to keep the result in memory.</p><pre><code class="language-julia hljs">using HetaSimulator, CSV, DataFrames

platform = load_platform(&quot;$HetaSimulatorDir/test/examples/single_comp&quot;)
model = platform.models[:nameless]

sc1 = Scenario(model, (0., 200.), observables=[:r1])

function output_func1(sol, i)
  CSV.write(&quot;sol_$i.csv&quot;, DataFrame(sol))
  return (nothing, false)
end

mc1 = mc(sc1, [:k1=&gt;Normal(0.02,1e-3)], 5; output_func=output_func1)</code></pre><h2 id="reduction_func-examples"><a class="docs-heading-anchor" href="#reduction_func-examples"><code>reduction_func</code> examples</a><a id="reduction_func-examples-1"></a><a class="docs-heading-anchor-permalink" href="#reduction_func-examples" title="Permalink"></a></h2><p>There arу two  keyword arguments to <code>mc()</code> or <code>sim</code> that control how results are processed in batches:</p><ul><li><code>batch_size</code> - The number of simulations in each batch passed to <code>reduction_func</code>. Defaults to the total number of simulations.</li><li><code>pmap_batch_size</code> - The number of simulations distributed per worker (if using <code>EnsembleDistributed</code>).  Defaults to <code>batch_size÷100 &gt; 0 ? batch_size÷100 : 1</code>.</li></ul><p>For more details, see the <a href="https://docs.sciml.ai/DiffEqDocs/dev/features/ensemble">SciML docs</a></p><h3 id="Saving-batches-of-simulations"><a class="docs-heading-anchor" href="#Saving-batches-of-simulations">Saving batches of simulations</a><a id="Saving-batches-of-simulations-1"></a><a class="docs-heading-anchor-permalink" href="#Saving-batches-of-simulations" title="Permalink"></a></h3><p>This <code>reduction_func</code> saves each batch of simulations to disk as a CSV file, using the batch index range (e.g., <code>sol_1_10.csv</code>). The batch of results is wrapped in an <code>MCResult</code> object to convert it to a <code>DataFrame</code>.</p><pre><code class="language-julia hljs">using HetaSimulator, CSV, DataFrames

platform = load_platform(&quot;$HetaSimulatorDir/test/examples/single_comp&quot;)
model = platform.models[:nameless]

sc1 = Scenario(model, (0., 200.), observables=[:r1])

function reduction_func1(u,batch,I)
  mcres_batch = HetaSimulator.MCResult(batch, true, nothing)
  df_batch = DataFrame(mcres_batch)
  CSV.write(&quot;sol_$(first(I))_$(last(I)).csv&quot;, df_batch)
  
  (u, false)
end

mc1 = mc(sc1, [:k1=&gt;Normal(0.02,1e-3)], 100; batch_size=10, reduction_func=reduction_func1)</code></pre><h3 id="Filtering-plausible-simulation-results"><a class="docs-heading-anchor" href="#Filtering-plausible-simulation-results">Filtering plausible simulation results</a><a id="Filtering-plausible-simulation-results-1"></a><a class="docs-heading-anchor-permalink" href="#Filtering-plausible-simulation-results" title="Permalink"></a></h3><p>This <code>reduction_func</code> filters out simulations where the value of observable <code>:r1</code> at <code>t=200</code>.0 is not greater than 0.004. Only simulations meeting this criterion are pushed into the accumulator <code>u</code>. After all simulations, <code>u</code> will contain only the filtered subset.</p><pre><code class="language-julia hljs">using HetaSimulator, CSV, DataFrames

platform = load_platform(&quot;$HetaSimulatorDir/test/examples/single_comp&quot;)
model = platform.models[:nameless]

sc1 = Scenario(model, (0., 200.), observables=[:r1])

function reduction_func2(u, batch, I)
  for s in batch
    t1 = 200.
    var = :r1
    if s(t1, var) &gt; 0.004
      push!(u, s)
    end
  end
  (u,false)
end

mc1 = mc(sc1, [:k1=&gt;Normal(0.02,1e-3)], 100; reduction_func=reduction_func2)</code></pre></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../solvers/">« Solver choice</a><a class="docs-footer-nextpage" href="../../tutorial/intro/">Introduction »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.13.0 on <span class="colophon-date" title="Monday 30 June 2025 13:27">Monday 30 June 2025</span>. Using Julia version 1.11.5.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
